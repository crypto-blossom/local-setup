name: e2e summary

on:
  schedule:
    - cron: '0 0 * * *'

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
        - uses: actions/checkout@v2

        - name: installing JSON processor - jq
          run: apt-get install jq
          
        - name: Rebasing master branch
          run: |
            git checkout gh-pages
            git rebase --strategy-option theirs origin master
        
        - name: Updating tbtc.js version
          run: |
            cd e2e
            jq '.dependencies."@keep-network/tbtc.js" = $TBTCJS_VERSION \
            package.json > package.json.tmp && mv package.json.tmp package.json
          env:
            TBTCJS_VERSION: 0.17.0-rc.1

        - name: Installing npm dependencies
          run: cd e2e && npm install
        
        - name: Running e2e summary test 
          run: | 
            cd e2e
            node --experimental-json-modules e2e-summary.js \
            --bitcoin-electrum-host 34.70.251.19 \
            --bitcoin-electrum-port 8080 \
            --bitcoin-network testnet \
            --ethereum-node wss://ropsten.infura.io/ws/v3/880f2a054e784898a55627bd5f047917 \
            --ethereum-pk 033cea2b77cbd50c02cbc57573cf4389b8c785642c2107c7e1614df9876b787b

        - name: Deploy e2e summary site
          run: |
            git config --local user.email "cron-e2e-summary@github.com"
            git config --local user.name ${{github.actor}}

            git commit e2e/site/index.html -m "Updating e2e summary page" || echo "No changes to commit"
            git push --force "https://${{github.actor}}:${{secrets.Token}}@github.com/${{github.repository}}.git"
